/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.7.1/userguide/building_java_projects.html
 */

plugins {
    // Apply the groovy plugin to also add support for Groovy (needed for Spock)
    id 'groovy'
    id 'java'
    // Apply the JaCoCo plugin for test coverage
    id 'jacoco'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Use a newer Groovy version that supports newer Java versions
    testImplementation 'org.codehaus.groovy:groovy-all:3.0.17'

    // Use a newer Spock version that supports newer Java versions
    testImplementation 'org.spockframework:spock-core:2.3-groovy-3.0'
    testImplementation 'junit:junit:4.13.2'

    // Required for JUnit 4 support in newer Gradle versions
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

// Configure Java compatibility for newer Java versions
java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

compileGroovy {
    sourceCompatibility = '17'
    targetCompatibility = '17'
}

compileTestGroovy {
    sourceCompatibility = '17'
    targetCompatibility = '17'
}

test{
    // Use JUnit Platform for running Spock tests
    useJUnitPlatform()
    
    // Configure test logging
    testLogging {
        events "passed", "skipped", "failed", "standardOut"
        showStandardStreams = true
        exceptionFormat = 'full'
    }
    
    // Always generate test reports
    reports {
        junitXml.required = true
        html.required = true
    }
    
    // Enable test coverage
    finalizedBy jacocoTestReport
}

jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }
    
    // Special configuration for Jenkins shared libraries
    // Include Groovy source files in coverage report
    getSourceDirectories().from(files("vars"))
    getClassDirectories().from(files("vars"))
    
    // Exclude non-code files
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, include: ['**/*.groovy'])
        }))
    }
}

// Add a task to check coverage limits
jacocoTestCoverageVerification {
    dependsOn jacocoTestReport
    violationRules {
        rule {
            element = 'BUNDLE'
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.0 // Set to a higher value if needed
            }
        }
    }
}

// Create a combined task for test and coverage
task testCoverage {
    group = 'verification'
    description = 'Runs tests and generates coverage report'
    dependsOn test, jacocoTestReport, jacocoTestCoverageVerification
}

// Custom task to analyze test coverage for Jenkins shared libraries
task analyzeCoverage {
    group = 'verification'
    description = 'Analyzes test coverage for Jenkins shared library'
    dependsOn test
    
    doLast {
        def testReportDir = file('build/test-results/test')
        def sourceDir = file('vars')
        
        if (testReportDir.exists() && sourceDir.exists()) {
            def sourceFiles = sourceDir.listFiles({it.name.endsWith('.groovy')} as FileFilter)
            def testFiles = file('src/test/groovy').listFiles({it.name.endsWith('.groovy')} as FileFilter)
            
            println "=== Test Coverage Analysis ==="
            println "Source files found: ${sourceFiles?.size() ?: 0}"
            println "Test files found: ${testFiles?.size() ?: 0}"
            
            if (sourceFiles) {
                println "\nSource files:"
                sourceFiles.each { file ->
                    println "  - ${file.name}"
                }
            }
            
            if (testFiles) {
                println "\nTest files:"
                testFiles.each { file ->
                    println "  - ${file.name}"
                }
            }
            
            // Calculate test to source ratio
            if (sourceFiles && sourceFiles.size() > 0) {
                def ratio = testFiles.size() / sourceFiles.size()
                println "\nTest-to-source file ratio: ${String.format("%.2f", ratio)}"
            }
            
            println "\nTest results:"
            def xmlReport = new File(testReportDir, 'TEST-MyStepsSpec.xml')
            if (xmlReport.exists()) {
                def xml = new XmlSlurper().parse(xmlReport)
                def tests = xml.@tests.toInteger()
                def failures = xml.@failures.toInteger()
                def errors = xml.@errors.toInteger()
                def skipped = xml.@skipped.toInteger()
                
                println "  Total tests: $tests"
                println "  Failures: $failures"
                println "  Errors: $errors"
                println "  Skipped: $skipped"
                if (tests > 0) {
                    def successRate = (tests - failures - errors - skipped) * 100.0 / tests
                    println "  Success rate: ${String.format("%.1f", successRate)}%"
                }
            }
            
            println "\nNote: For Jenkins shared libraries, traditional code coverage"
            println "tools like JaCoCo may not work as expected because the code"
            println "consists of script files rather than compiled classes."
            println "The most important metric is having comprehensive tests"
            println "that cover all use cases of your shared library functions."
        } else {
            println "Cannot generate coverage analysis - required directories not found"
        }
    }
}

jar.enabled = false